{% extends 'core/layout_split.html' %}
{% load staticfiles compress guardian_tags threadedcomments_tags %}


{% block css %}
    <link rel="stylesheet" type="text/css" href="{% static "css/vizi.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "adminmap.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "lib/jquery-ui/jquery-ui.theme.min.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "lib/jquery-ui/jquery-ui.min.css" %}" />
    {% compress css %}
    {{block.super}}
    <link rel="stylesheet" href="{% static "lib/leaflet/leaflet.css" %}" />
    <link rel="stylesheet" type="text/x-scss" href="{% static "css/details.scss" %}" />
    {% endcompress %}
{% endblock %}

{% block js %}

    <script type="text/javascript" src="{% static 'lib/leaflet/leaflet.js' %}" ></script>
    <script type="text/javascript" src="{% static 'lib/OSMBuildings-Leaflet.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'lib/modernizr.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'lib/vertical-timeline.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'lib/vizicities/vizi.min.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'lib/vizicities/tween.min.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'lib/jquery-ui/jquery-ui.min.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'js/Blueprints/BlueprintOutputPolygon.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'js/Blueprints/BlueprintInputPolygon.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'js/Blueprints/BlueprintOutputCustomBuildingTiles.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'js/3d.js' %}"  ></script>
    <script type="text/javascript" src="{% static 'adminmap.js' %}"  ></script>
    

    <script type="text/javascript">
        var _static_url = {% static '' %}
        var _tiles_url = "{{tiles_url}}";
        var _tiles_opt = {{tiles_opt|safe}};
        var _default_view = {{default_view|safe}};

        var _lon = {{ project.lon|stringformat:"F" }};
        var _lat = {{ project.lat|stringformat:"F" }};
        var _address = "{{ project.address|safe }}";
        var _polygon = {% if project.polygon %}{{project.polygon|safe}}{% else %}[]{% endif %};
        if (!window.wbc3d) {
            window.wbc3d_conf = {};
            // wbc3d_conf.DATADIR = "{% static 'lib/wbc3d/data/' %}";
            wbc3d_conf.WORKERPATH = "../..{% static 'lib/vizicities/vizi-worker.min.js' %}";
        }
    </script>
    <script type="text/javascript" src="{% static 'js/details.js' %}" ></script>
    <script type="text/javascript" src="{% static 'js/angular-mapservice.js' %}" ></script>
{% endblock %}

{% block controller %}
DetailsController
{% endblock %}

{% block side_content %}
{% if user.is_authenticated %}
{% get_obj_perms user for project as "project_perms" %}
{% endif %}
<div id="project_sidebar">
    <div class="anchor">
        <div class="details-headline content-container">
            <h1> {{project.name}} </h1>

           
            {% if project.address_obj %}

            <a class="map-link" data-toggle="tab" href="#project_map">
                <div class="address">
                    {{project.address_obj}}
                </div>
            </a>
            {% endif %}
        </div>
        {% if user.is_authenticated %}
        <ul class="admin-panel">
            <li><a class="admin-link project-admin" data-toggle="modal" data-target="#edit-modal" data-form="{% url 'project_create' %}" href="#"><i class="fa fa-plus"></i></a></li>
            {% if 'change_project' in project_perms %}
            <li><a class="admin-link project-admin" data-form="{% url 'project_update' project.pk %}" href="#"><i class="fa fa-pencil"></i></a></li>
            {% endif %}
         <!--    <li><a class="admin-link" href="{{new_publication_link}}?project_id={{project.pk}}"><i class="fa fa-newspaper"></i></a></li> -->
        </ul>
        {% endif %}
        <div id="participate-widget" class="widget">
        {% if processSteps %}
            {% for pub in processSteps %}
                {% if pub.process_step.participation %}
                    <div><img class="participation" src="/static/img/participation.png" title="Bürgerbeteiligung möglich"></div>
                {% else %}
                    <div><img class="no-participation" src="/static/img/no-participation.png" title="Beteiligung zur Zeit nicht möglich"></div>
                {% endif %}
           <!--  <div class="current-step tooltip-container">
                 <span class="fa-stack fa-2x">
                    <i class="fa fa-circle-thin fa-stack-2x"></i>
                    <i class="fa fa-gears fa-stack-1x fa-inverse"></i>
                </span>
                <p>
                {{pub.process_step}}
                </p>
                <div class="tooltip">
                    <p><b>{{pub.process_step}}</b></p>
                    {{pub.process_step.description}}
                </div>
            </div> -->
            {% endfor %}
        {% endif %}
        </div>

    </div>

  <!--   <div class="availability-icons">
        {% if gallery %}
        <a title="Information" href="#info"><i class="fa fa-info fa-2x"></i></a>
        {% endif %}

        <a class="map-link" title="Karte" href="#project_map"><i class="fa fa-map-marker fa-2x"></i></a>

        {% if gallery %}
        <a title="Bilder" href="#gallery"><i class="fa fa-image fa-2x"></i></a>
        {% endif %}
        {% if stakeholders %}
        <a title="Beteiligte" href="#info"><i class="fa fa-user fa-2x"></i></a>
        {% endif %}
        {% if buildings %}
        <a title="3D" href="#info"><i class="fa fa-cube fa-2x"></i></a>
        {% endif %}
    </div> -->


    {% if gallery %}
    <img class="project-image" u="image" src="{{ gallery.0.latest.0.get_description_url }}" />
        
    {% endif %}

    {% if project.description %}
    <div class="teaser-text">
        {{project.get_teaser}}
    </div>
    {% endif %}

    <div id="subscribe-widget" class="widget">
        <button class="btn default wbc-button">
            <span class="fa-stack">
              <i class="fa fa-circle-thin fa-stack-2x"></i>
              <i class="fa fa-bell fa-stack-1x fa-lg"></i>
            </span>
            Benachrichtigungen
        </button>
    </div>



    {% if nextDate %}
    <a class="event-item" data-toggle="tab" href="#timeline">
        <div id="next-date-widget" class="widget">
            <div class="content-container">
                <h3><i class="fa fa-calendar"> </i>Nächster Termin</h3>
                {% if 'change_project' in project_perms %}
                <ul class="admin-panel">
                    <li><a class="admin-link" data-toggle="modal" data-target="#event-modal" href="#"><i class="fa fa-plus"></i></a></li>
                </ul>
                {% endif %}

                <p>{{nextDate.title}}</p>
                <p>{{nextDate.begin}}</p>
                <p>{{nextDate.address}}</p>
            </div>
        </div>
    </a>
    {% endif %}
    
    {% if lastNews %}
    <a class="event-item" data-toggle="tab" href="#timeline">
        <div id="last-news-widget" class="widget">
            <div class="content-container"> 
                <h3><i class="fa fa-newspaper-o"> </i>Letzte Neuigkeiten</h3>
                <p>{{lastNews.title}}</p>
                <p>{{lastNews.teaser}}</p>
                <p>{{lastNews.begin}}</p>
            </div>
        </div>
    </a>
    {% endif %}

    {% if tags %}
    <div id="tags-widget" class="widget">
        <div class="content-container">
            <h3><i class="fa fa-tags"> </i>Stichwörter</h3>
            {% for tag in tags %}
                <a class="taglink" href="{{tag.get_absolute_url}}">{{tag.name}}</a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}


{% block main_content %}

    <div id="edit-modal" class="modal fade" role="dialog" tabindex="-1">
        <div class="well modal-dialog modal-content modal-lg" role="document">
             <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h3> hinzufügen </h3>
            </div>
            <div class="custom-content">
            </div>
        </div>
    </div>
    <div id="event-modal" class="modal fade" role="dialog" tabindex="-1">
        <div class="well modal-dialog modal-content modal-lg" role="document">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">×</button>
                <h3> Event hinzufügen </h3>
                <ul class="nav nav-pills">
                    <li role="presentation"><a class="admin-link event-admin btn" data-form="{% url 'date_create' project.pk %}" href="#">Veranstaltung</a></li>
                    <li role="presentation"><a class="admin-link event-admin btn" data-form="{% url 'media_create' project.pk %}" href="#">Nachricht</a></li>
                    <li role="presentation"><a class="admin-link event-admin btn" data-form="{% url 'pub_create' project.pk %}" href="#">Veröffentlichung</a></li>
                </ul>
            </div>
            <div class="custom-content">

            </div>
        </div>
    </div>
    
    <ul class="wbc-nav main-content-nav nav nav-tabs" data-tabs="tabs">
        <li class="active"><a data-toggle="tab" href="#info"><i class="fa fa-info"></i>Info</a></li>
        <li><a class="map-link" data-toggle="tab" href="#project_map"><i class="fa fa-map-marker"></i>Karte</a></li>
        <li  {{gallery|yesno:' ,class=not-active'}}><a data-toggle="tab" href="#gallery"><i class="fa fa-image"></i>Bilder</a></li>
        <li>
            <a data-toggle="tab" href="#timeline"><i class="fa fa-calendar"></i>Ereignisse</a>
        </li>
        <li>
            <a data-toggle="tab" href="#stakeholder"><i class="fa fa-user"></i>Beteiligte</a> 
        </li>
        <li><a class="3d-link" data-toggle="tab" href="#3d"><i class="fa fa-cube"></i>3D</a></li>
        <li><a data-toggle="tab" href="#discussion"><i class="fa fa-comment"></i>Diskussion ({% get_comment_count for project as count %}{{count}})</a></li>
    </ul>   

    <div id="tab-content" class="tab-content">
        <div id="info" class="tab-pane active">
            <div class="content-container">
                <h3>Beschreibung</h3>
                <p>
                    {{ project.description | linebreaks }}
                </p>

                {% if project.description_official %}
                 <p>
                    <strong>Genaue örtliche Beschreibung (Amtsblatt):</strong> {{ project.description_official }}
                 </p>
                {% endif %}

                <p>
                    <strong>im Bezirk/in den Bezirken:</strong> {{ project.entities.all|join:", "}}
                </p>
            </div>

            {% if processTypes %}
            <div class="container-fluid">
                {% include "process/process_bar.html" %}
                <div class="processstep-text">
                    <h4>{{processSteps.0.process_step.name}}</h4>
                    <p>{{processSteps.0.process_step.description}}</p>
                </div>
            </div>
            {% endif %}

        </div>
        <div id="project_map" class="tab-pane">
             <div id="map"></div>
        </div>

        <div id="gallery" class="tab-pane">
        {% if gallery %}
           {% include "projects/project_gallery.html" %}
        {% endif %}
        </div>

        <div id="timeline" class="tab-pane">
            {% include "projects/project_events.html" %}
        </div>
             
        <div id="stakeholder" class="tab-pane">
            {% include "projects/project_stakeholder.html" %}
        </div>
        
        <div id="3d" class="tab-pane">
            <div id="vizicities-viewport">
                <div class="vizicities-ui-item" id="vizi-menu">
                    <button class="btn btn-default" id="citygml-switch"> old/new </button>
                    <button class="btn btn-default" id="camera-flight"> Kameraflug </button>
                    <button class="btn btn-default" id="north"> N </button>
                    <button class="btn btn-default" id="west"> W </button>
                    <button class="btn btn-default" id="east"> E </button>
                    <button class="btn btn-default" id="south"> S </button>
                </div>
            </div>
        </div>
        <div id="discussion" class="tab-pane">
            {% if user.is_authenticated %}
                {% render_comment_form for project %}
            {% else %}
                <a class="dropdown-toggle" data-toggle="dropdown" data-target=".dropdown" href="#" >Melden</a> Sie sich an um ein Kommentar zu hinterlassen.
            {% endif %}
            
            {% render_comment_list for project %}
        </div>
    </div>
</div>
{% endblock %}