{% extends 'core/layout_split.html' %}
{% load staticfiles compress i18n %}

{% block css %}
    {% compress css %}
    {{block.super}}
    <link rel="stylesheet" type="text/x-scss" href="{% static "css/search.scss" %}" />
    <link rel="stylesheet" href="{% static 'lib/leaflet/leaflet.css' %}" />
    {% endcompress %}
{% endblock %}

{% block js %}
    <script type="text/javascript" src="{% static 'lib/leaflet/leaflet.js' %}" ></script>

    <script type="text/javascript" src="{% static 'js/search.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/angular-mapservice.js' %}"></script>
    <script type="text/javascript">
        var _static_url = {% static '' %}
        var _tiles_url = "{{tiles_url}}";
        var _tiles_opt = {{tiles_opt|safe}};
        var _default_view = {{default_view|safe}};
    </script>
{% endblock %}

{% block controller %}
SearchController
{% endblock %}

{% block side_content %}
<!-- base for html5 mode angular -->
<base href="/suche/">
    <div id="search_sidebar" ng-class="{'show-overflow' : searchFocus}">
        <form id="search" ng-submit="$event.preventDefault(); startSearch(false)">
            {% csrf_token %}
            <div class="search-anchor anchor">
                <div class="input-group search-field">
                    <input
                    placeholder="{% trans 'PLACEHOLDER:Suche nach Ideen, Ansprechpartnern und Projekten in deinem Landkreis...' %}"
                    type="text" class="form-control"
                    ng-model="formData.q"
                    ng-change="onSearchChanged()"
                    ng-keydown="onKeyDown($event)" 
                    ng-focus="searchFocus=true"
                    ng-blur="searchFocus=false"

                    >
                    
                    <a ng-if="activeSearch" ng-click="clearSearch()" class="text-muted clear-search" href="#" title="{% trans 'Suche zurücksetzen' %}">
                        <i class="fa fa-times"></i>
                    </a>

                    <a href="" class="input-group-addon" onclick="$('#search').submit()">
                        <span class="glyphicon glyphicon-search"></span>
                    </a>
                </div>
                <div ng-show="suggestions.length >0 && searchFocus" class="search-results-autocomplete">
                    <div ng-repeat="result in suggestions">
                        <div class="search-result-autocomplete"
                             ng-click="console.log('ASD');selectTerm(result.name);startSearch(false);"
                              ng-class="{'selected-result': $index == selectedSuggestionIdx}"
                              ng-mouseover="setIndex($index)"
                             >
                                <b>{[{ result.name }]}</b>
                        </div>
                    </div>
                </div>
                <a class="pull-left visible-xs" href="" ng-click="showFilter = !showFilter"> Erweiterte Suche</a>

                <p id="result-number" class="text-muted" ng-if="resultLength">{[{results.length}]} von {[{resultLength}]} {% trans 'Einträgen' %}
                    <a href="#" ng-if="results.length < resultLength"ng-click="startSearch(offset)">{% trans 'more' %}</a>
                    <a href="#" ng-if="results.length < resultLength"ng-click="startSearch(1)">{% trans 'all' %}</a>
                </p>
                <div ng-if="suggestion" class="suggestion-container">
                    {% trans 'SPELLING SUGGESTION:Meinten Sie:' %} <a href="" ng-click="selectTerm(suggestion)">
                        {[{suggestion}]}
                    </a>
                </div>
                
              <!--   <a href="" class="scroll-top-link hidden-xs" onclick="$('#search_sidebar').scrollTop(0)"> <i class="fa-angle-double-up fa"></i> FILTER</a> -->
                <a href="" class="scroll-top-link-bottom" onclick="$('#search_sidebar').scrollTop(0)"> <i class="fa-angle-double-up fa fa-2x"></i></a>

            </div>
            <div id="filter-container">
                <div ng-if="entitiesFacets.length > 0" class="facet-container">
                    <div ng-click="toggleSelectedItems($event)" class="collapse-heading collapsed" data-toggle="collapse" data-target=".region-facets">
                        <i class="region-anchor anchor fa fa-image"></i>{% trans 'ENTITY-FILTER: Stadtteile' %}
                    </div>
                    <div class="active-facets wbc-dropdown-container">
                         <div class="facet-item" ng-repeat="entity in formData.entities">
                            <span>{[{entity}]}</span>
                            <a ng-click="formData.entities.splice(formData.entities.indexOf(entity), 1); startSearch()" class="close-button">
                                <i class="remove glyphicon glyphicon-remove-sign glyphicon-white"></i>
                            </a>
                        </div>
                    </div>
                    <div id='region-facets' class='region-facets collapse wbc-dropdown-container'>
                        <div class="facet-select" ng-repeat="facet in entitiesFacets">
                            <label>
                                <input type="checkbox" checklist-model="formData.entities" checklist-value="facet[0]" ng-click="startSearch()">
                                    {[{facet[0]}]} ({[{facet[1]}]})
                            </label>
                        </div>
                    </div>
                </div>

                <div ng-if="tagFacets.length > 0" class="facet-container">
                    <div ng-click="toggleSelectedItems($event)" class="collapse-heading collapsed" data-toggle="collapse" data-target="#tag-facets">
                        <i class="tag-anchor anchor fa fa-tags"></i>{% trans 'TAG-FILTER:Stichwörter' %}
                    </div>
                    <div class="active-facets wbc-dropdown-container">
                        <div class="facet-item" ng-repeat="tag in formData.tags">
                            <span>{[{tag}]}</span>
                            <a class="close-button" ng-click="formData.tags.splice(formData.tags.indexOf(tag), 1); startSearch();"><i class="remove glyphicon glyphicon-remove-sign glyphicon-white"></i></a>
                        </div>
                    </div>
                    <div id='tag-facets' class="collapse wbc-dropdown-container">
                        <div class="facet-select" ng-repeat="facet in tagFacets">
                            <label>
                                <input type="checkbox" checklist-model="formData.tags" checklist-value="facet[0]" ng-click="startSearch()">
                                    {[{facet[0]}]} ({[{facet[1]}]})
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </form>
         <div ng-show="searching" class="text-center loading-container">
            <i class="spinner-icon fa fa-spinner fa-spin"></i>
            <div class="loading-text"> {% trans 'Suche' %}</div>
        </div>
        
        <!-- Result list in sidebar -->
        <div id="sidebar-results" ng-hide="listView" ng-if="resultLength">
           
            <div class="collapse-heading" data-toggle="collapse" data-target=".result-list"><i class="result-anchor anchor fa fa-list-ul"> </i>{% trans '#ERGEBNISSE:Ergebnisse' %}</div>
           
            <div class="result-list in wbc-dropdown-container">

                <div class="clearfix"
                    ng-repeat="result in results"
                    ng-mouseover="focusResult(result)"
                    ng-mouseout="defocusResult(result)"
                    ng-click="selectResult(result)">

                    <div id="result-{[{result.pk}]}" class="search-result">
                        <div class="result-type" ng-switch on="result.type">
                            <i ng-switch-when="project" class="fa fa-home fa-2x"></i>
                            <i ng-switch-when="stakeholder" class="fa fa-user fa-2x"></i>
                        </div>
                        <div class="result-details">
                            <a ng-href="{[{result.internal_link}]}">
                                <b>{[{ result.name }]}</b>
                            </a>
                            <p ng-if="result.address_obj">{[{ result.address_obj }]}</p>
                        </div>
                    </div>
                </div>
                <a href="#" ng-if="results.length < resultLength"ng-click="startSearch(offset)">{% trans 'more' %}</a>
            </div>
        </div>

    </div>
{% endblock %}
{% block main_content %}
    <!-- <ul class="nav-tabs nav">
        <li><button class="btn btn-default" id="map-list-switch"><i class='fa fa-map'></i></button></li>
        <li><button class="btn btn-default" id="map-list-switch"><i class='fa fa-list'></i></button></li>
        <li><button class="btn btn-default" id="map-list-switch"><i class='fa fa-book'></i></button></li>
    </ul> -->

    <button class="btn btn-default" id="map-list-switch" ng-click="changeView()">{% trans 'Button:Listen-/Kartenansicht' %}</button>
    <div ng-class="{'active-result': !listView}" class="result-content" id="map">

        <!-- INFO BOX ON MAP, shows selected Result -->
        <div ng-if="selectedResult != null" class="map-overlay" id="map-info-box">
            <h2>{[{selectedResult.name}]}</h2>
            <a ng-href="{[{selectedResult.internal_link}]}">Details</a>
        </div>

        <!-- LEGEND -->
        <div class="map-overlay" id="legend">
            <!-- <h2>{% trans 'Legende' %}</h2> -->
            <div>
                <svg width="40" height="18" class="wbc-poly">
                    <rect width="40" height="18" />
                </svg> <span>Bebauungspläne</span>
            </div>
            <div>
                <svg width="40" height="18" class="buffer-area wbc-poly">
                    <rect width="40" height="18" />
                </svg> <span>Ausgleichsflächen</span>
            </div>
            
        </div>

    </div>
    <div ng-class="{'active-result': listView}" class="result-content" id="list">
        <div id='search-list-header' class="fixed-top">
            <div class="pull-left result-number text-center">
                <div ng-show="resultLength >=0 && !searching">
                    <h3>{[{results.length}]} von {[{resultLength}]}</h3>
                    <p>{% trans '#ERGEBNISSE:Ergebnisse' %}</p>
                </div>
                <div ng-show="searching">
                    <i class="spinner-icon fa fa-spinner fa-spin"></i>
                    <div class="loading-text"> {% trans 'Suche' %}</div>
                </div>
            </div>
            <div class="sort-control pull-left">
                <p>{% trans 'Sortieren nach:' %}</p>
                <ul class="tabs">
                    <!-- <button value="" class="order-btn active btn btn-default">{% trans 'BUTTON:Relevanz' %}</button> -->
                    <button value="name" class="order-btn btn btn-default">{% trans 'BUTTON:Name' %}</button>
                    <button value="-created" class="order-btn btn btn-default">{% trans 'BUTTON:Datum' %}</button>
                    <!-- <button value="-num_stakeholder" class="order-btn btn btn-default">{% trans 'BUTTON:# Beteiligte' %}</button> -->
                    <button value="-ratings_avg" class="order-btn btn btn-default">{% trans 'BUTTON:Bewertung' %}</button>
                    <!-- <button value="-ratings_count" class="order-btn btn btn-default">{% trans 'BUTTON:# Bewertungen' %}</button> -->
                </ul>
            </div>
        </div>
        <div id="result-list">
            <div ng-repeat="result in results">
                <div id="result-{[{result.pk}]}" class="search-result  container-fluid">
                    <div class="left-block pull-left">
                        <a ng-href="{[{result.internal_link}]}">
                            <img ng-if="result.thumbnail" class="search-thumbnail" src={[{result.thumbnail}]}>
                            <img ng-if="!result.thumbnail" class="search-thumbnail" src="/static/img/project_placeholder100.png">
                        </a>
                    </div>
                    <div class="right-block">
                        <div class="result-mash">
                            <div class="pull-left result-block">
                                <div class="result-type" ng-switch on="result.type">
                                    <i ng-switch-when="project" class="fa fa-lightbulb-o fa-2x"></i>
                                    <i ng-switch-when="stakeholder" class="fa fa-user fa-2x"></i>
                                </div>
                                <a ng-href="{[{result.internal_link}]}">
                                    <b>{[{ result.name }]}</b>
                                </a>
                                <p ng-if="result.address_obj">{[{ result.address_obj }]}</p>
                            </div>
                            <div class="pull-left result-block">
                                <p ng-if="result.num_stakeholder">{% trans '#FOLLOWER:Beteiligte:' %}' {[{result.num_stakeholder}]}</p>
                            </div>
                            <div class="pull-right result-block">
                                <p ng-if="result.created">{% trans 'Erstellt am:' %} {[{result.created}]}</p>
                                <p ng-if="result.created_by">{% trans 'Erstellt von:' %}' {[{result.created_by}]}</p>
                                <p ng-if="result.ratings_avg">{% trans 'Bewertung: &Oslash;' %}' {[{result.ratings_avg}]} ({[{result.ratings_count}]})</p>
                            </div>
                            <p class="teaser" ng-if="result.teaser">{[{result.teaser}]}</p>
                        </div>
                    </div>
                </div>
            </div>
            <button ng-if='results.length < resultLength' class="load-more-results btn btn-default">{% trans 'Mehr Ergebnisse laden' %}</button>
        </div>
    </div>
    
{% endblock %}
