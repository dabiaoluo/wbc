{% extends 'core/layout_split.html' %}
{% load staticfiles compress %}

{% block css %}
    {% compress css %}
    {{block.super}}
    <link rel="stylesheet" type="text/x-scss" href="{% static "css/search.scss" %}" />
    <link rel="stylesheet" href="{% static 'lib/leaflet/leaflet.css' %}" />
    {% endcompress %}
{% endblock %}

{% block js %}
    <script type="text/javascript" src="{% static 'lib/leaflet/leaflet.js' %}" ></script>

    <script type="text/javascript" src="{% static 'js/search.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/angular-mapservice.js' %}"></script>
    <script type="text/javascript">
        var _static_url = {% static '' %}
        var _tiles_url = "{{tiles_url}}";
        var _tiles_opt = {{tiles_opt|safe}};
        var _default_view = {{default_view|safe}};
    </script>
{% endblock %}

{% block controller %}
SearchController
{% endblock %}

{% block side_content %}
    <div id="search_sidebar">
        <form id="search">
            {% csrf_token %}
            <div class="search-anchor anchor">
                <div class="input-group search-field">
                    <input
                    placeholder="Bauprojekte, Akteure und Projekte durchsuchen"
                    type="text" class="form-control"
                    ng-model="formData.searchTerm"
                    ng-change="onSearchChanged()"
                    ng-keydown="onKeyDown($event)"
                    ng-model-options="{ debounce: 1200 }"
                    ng-init="formData.searchTerm = '{{searchTerm}}'">

                    <a href="" class="input-group-addon" ng-click="search()">
                        <span class="glyphicon glyphicon-search"></span>
                    </a>
                </div>
                <div ng-if="suggestion" class="suggestion-container">
                    Meinten Sie: <a href="" ng-click="selectTerm(suggestion)">
                        {[{suggestion}]}
                    </a>
                </div>
            </div>
            <div ng-if="entitiesFacets.length > 0" class="facet-container">
                <div ng-click="toggleSelectedItems($event)" class="collapse-heading collapsed" data-toggle="collapse" data-target=".region-facets">
                    <i class="region-anchor anchor fa fa-image"></i>Stadtteile
                </div>
                <div class="active-facets wbc-dropdown-container">
                     <div class="facet-item" ng-repeat="entity in formData.entities">
                        <span>{[{entity}]}</span>
                        <a ng-click="formData.entities.splice(formData.entities.indexOf(entity), 1)" class="close-button">
                            <i class="remove glyphicon glyphicon-remove-sign glyphicon-white"></i>
                        </a>
                    </div>
                </div>
                <div id='region-facets' class='region-facets collapse wbc-dropdown-container'>
                    <div class="facet-select" ng-repeat="facet in entitiesFacets">
                        <label>
                            <input type="checkbox" checklist-model="formData.entities" checklist-value="facet[0]" checklist-change="onSearchChanged()">
                                {[{facet[0]}]} ({[{facet[1]}]})
                        </label>
                    </div>
                </div>
            </div>

            <div ng-if="tagFacets.length > 0" class="facet-container">
                <div ng-click="toggleSelectedItems($event)" class="collapse-heading collapsed" data-toggle="collapse" data-target="#tag-facets">
                    <i class="tag-anchor anchor fa fa-tags"> </i> Stichwörter
                </div>
                <div class="active-facets wbc-dropdown-container">
                    <div class="facet-item" ng-repeat="tag in formData.tags">
                        <span>{[{tag}]}</span>
                        <a class="close-button" ng-click="formData.tags.splice(formData.tags.indexOf(tag), 1)"><i class="remove glyphicon glyphicon-remove-sign glyphicon-white"></i></a>
                    </div>
                </div>
                <div id='tag-facets' class="collapse wbc-dropdown-container">
                    <div class="facet-select" ng-repeat="facet in tagFacets">
                        <label>
                            <input type="checkbox" checklist-model="formData.tags" checklist-value="facet[0]" checklist-change="onSearchChanged()">
                                {[{facet[0]}]} ({[{facet[1]}]})
                        </label>
                    </div>
                </div>
            </div>


            <!--
            <div ng-click="toggleSelectedItems($event)" class="collapse-heading collapsed" data-toggle="collapse" data-target="#type-facets">
                <i id="type-anchor" class="anchor fa fa-circle-o"> </i> Typen
            </div>
            <div class="active-facets wbc-dropdown-container">
                <div class="facet-item" ng-repeat="model in formData.models">
                    <span>{[{models[model]}]}</span>
                    <a class="close-button" ng-click="formData.models.splice(formData.models.indexOf(model), 1)"><i class="remove glyphicon glyphicon-remove-sign glyphicon-white"></i></a>
                </div>
            </div>
            <div id="type-facets" class="collapse wbc-dropdown-container" >
                <div ng-repeat="(key, text) in models"  class="facet-select">
                    <label>
                        <input type="checkbox" checklist-model="formData.models" checklist-value="key" checklist-change="onSearchChanged()">
                        {[{text}]}
                    </label>
                </div>
            </div>
            -->

        </form>
        <div ng-if="resultLength">
            <div class="collapse-heading" data-toggle="collapse" data-target=".result-list"><i class="result-anchor anchor fa fa-list-ul"> </i>Ergebnisse</div>
            <p id="result-number" class="wbc-dropdown-container text-muted" ng-if="resultLength">{[{resultLength}]} Einträge gefunden</p>
            <div class="result-list in wbc-dropdown-container">

                <div class="clearfix"
                    ng-repeat="result in results"
                    ng-mouseover="focusResult(result)"
                    ng-mouseout="defocusResult(result)"
                    ng-click="selectResult(result)">

                    <div id="result-{[{result.pk}]}" class="search-result">
                        <div class="result-type" ng-switch on="result.type">
                            <i ng-switch-when="project" class="fa fa-home fa-2x"></i>
                            <i ng-switch-when="stakeholder" class="fa fa-user fa-2x"></i>
                        </div>
                        <div class="result-details">
                            <a ng-href="{[{result.internal_link}]}">
                                <b>{[{ result.name }]}</b>
                            </a>
                            <p ng-if="result.address_obj">{[{ result.address_obj }]}</p>
                            <p ng-if="!result.address_obj">Keine Adresse</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block main_content %}
    <div id="map"></div>
{% endblock %}
